Ext.define("GeoExt.container.WmsLegend",{extend:"GeoExt.container.LayerLegend",alias:"widget.gx_wmslegend",requires:["GeoExt.LegendImage"],alternateClassName:"GeoExt.WMSLegend",statics:{supports:function(n){return n.getLayer()instanceof OpenLayers.Layer.WMS?1:0}},defaultStyleIsFirst:!0,useScaleParameter:!0,baseParams:null,initComponent:function(){var n=this,t;n.addEvents("legendimageloaded");n.callParent();t=n.layerRecord.getLayer();n._noMap=!t.map;t.events.register("moveend",n,n.onLayerMoveend);n.update()},onLayerMoveend:function(n){(n.zoomChanged===!0&&this.useScaleParameter===!0||this._noMap)&&(delete this._noMap,this.update())},getLegendUrl:function(n,t){var o=this.layerRecord,i,u=o&&o.get("styles"),r=o.getLayer(),h,c;t=t||[r.params.LAYERS].join(",").split(",");var s=r.params.STYLES&&[r.params.STYLES].join(",").split(","),l=Ext.Array.indexOf(t,n),f=s&&s[l],e={};return u&&u.length>0&&(f?Ext.each(u,function(n){return i=n.name==f&&n.legend&&n.legend.href,!i}):this.defaultStyleIsFirst!==!0||s||r.params.SLD||r.params.SLD_BODY||(i=u[0].legend&&u[0].legend.href),e=Ext.apply({},this.baseParams)),i||(h=Ext.apply({REQUEST:"GetLegendGraphic",WIDTH:null,HEIGHT:null,EXCEPTIONS:"application/vnd.ogc.se_xml",LAYER:n,LAYERS:null,STYLE:f!==""?f:null,STYLES:null,SRS:null,FORMAT:null,TIME:null},this.baseParams),i=r.getFullRequestString(h),e={}),r.params._OLSALT&&(e._OLSALT=r.params._OLSALT),i=Ext.urlAppend(i,Ext.urlEncode(e)),i.toLowerCase().indexOf("request=getlegendgraphic")!=-1&&(i.toLowerCase().indexOf("format=")==-1&&(i=Ext.urlAppend(i,"FORMAT=image%2Fgif")),this.useScaleParameter===!0&&(c=r.map.getScale(),i=Ext.urlAppend(i,"SCALE="+c))),i},update:function(){var f=this.layerRecord.getLayer(),t,i,n,r,u,e,o;if(f&&f.map){for(this.callParent(),t=[f.params.LAYERS].join(",").split(","),u=[],e=this.items.get(0),this.items.each(function(r){if(n=Ext.Array.indexOf(t,r.itemId),n<0&&r!=e)u.push(r);else if(r!==e){i=t[n];var f=this.getLegendUrl(i,t);OpenLayers.Util.isEquivalentUrl(f,r.url)||r.setUrl(f)}},this),n=0,r=u.length;n<r;n++)o=u[n],this.remove(o),o.destroy();for(n=0,r=t.length;n<r;n++)i=t[n],this.items&&this.getComponent(i)||this.add({xtype:"gx_legendimage",url:this.getLegendUrl(i,t),itemId:i,listeners:{legendimageloaded:function(){this.fireEvent("legendimageloaded",this)},scope:this}});this.doLayout()}},beforeDestroy:function(){if(this.useScaleParameter===!0){var n=this.layerRecord.getLayer();n&&n.events&&n.events.unregister("moveend",this,this.onLayerMoveend)}this.callParent()}},function(){GeoExt.container.LayerLegend.types.gx_wmslegend=GeoExt.container.WmsLegend})