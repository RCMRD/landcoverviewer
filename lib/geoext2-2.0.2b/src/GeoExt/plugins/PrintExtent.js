Ext.define("GeoExt.plugins.PrintExtent",{mixins:{observable:"Ext.util.Observable"},requires:["GeoExt.data.PrintPage"],alias:"widget.gx_printextent",alternateClassName:"GeoExt.PrintExtent",initialConfig:null,printProvider:null,map:null,layer:null,transformFeatureOptions:null,control:null,pages:null,page:null,constructor:function(n){n=n||{};Ext.apply(this,n);this.initialConfig=n;this.printProvider||(this.printProvider=this.pages[0].printProvider);this.pages||(this.pages=[]);this.callParent(arguments)},print:function(n){this.printProvider.print(this.map,this.pages,n)},init:function(n){this.map=n.map;n.on("destroy",this.onMapPanelDestroy,this);this.layer||(this.layer=new OpenLayers.Layer.Vector(null,{displayInLayerSwitcher:!1}));this.createControl();for(var t=0,i=this.pages.length;t<i;++t)this.addPage(this.pages[t]);this.show()},addPage:function(n){n=n||Ext.create("GeoExt.data.PrintPage",{printProvider:this.printProvider});Ext.Array.indexOf(this.pages,n)===-1&&this.pages.push(n);this.layer.addFeatures([n.feature]);n.on("change",this.onPageChange,this);this.page=n;var t=this.map;return t.getCenter()?this.fitPage():t.events.register("moveend",this,function(){t.events.unregister("moveend",this,arguments.callee);this.fitPage()}),n},removePage:function(n){Ext.Array.remove(this.pages,n);n.feature.layer&&this.layer.removeFeatures([n.feature]);n.un("change",this.onPageChange,this)},selectPage:function(n){this.control.active&&this.control.setFeature(n.feature)},show:function(){this.map.addLayer(this.layer);this.map.addControl(this.control);this.control.activate();this.page&&this.map.getCenter()&&this.updateBox()},hide:function(){var n=this.map,i=this.layer,t=this.control;t&&t.events&&(t.deactivate(),n&&n.events&&t.map&&n.removeControl(t));n&&n.events&&i&&i.map&&n.removeLayer(i)},onMapPanelDestroy:function(){for(var t,i,n=this.map,u=this.pages.length-1,r=u;r>=0;r--)this.removePage(this.pages[r]);this.hide();t=this.control;n&&n.events&&t&&t.events&&t.destroy();i=this.layer;!this.initialConfig.layer&&n&&n.events&&i&&i.events&&i.destroy();delete this.layer;delete this.control;delete this.page;this.map=null},createControl:function(){this.control=new OpenLayers.Control.TransformFeature(this.layer,Ext.applyIf({preserveAspectRatio:!0,eventListeners:{beforesetfeature:function(n){for(var t=0,i=this.pages.length;t<i;++t)if(this.pages[t].feature===n.feature){this.page=this.pages[t];n.object.rotation=-this.pages[t].rotation;break}},setfeature:function(n){for(var t=0,i=this.pages.length;t<i;++t)if(this.pages[t].feature===n.feature){this.fireEvent("selectpage",this.pages[t]);break}},beforetransform:function(n){var t;if(this._updating=!0,t=this.page,n.rotation)this.printProvider.layout.get("rotation")?t.setRotation(-n.object.rotation):n.object.setFeature(t.feature);else if(n.center)t.setCenter(OpenLayers.LonLat.fromString(n.center.toShortString()));else{t.fit(n.object.box,{mode:"closest"});var u=this.printProvider.scales.getAt(0),f=this.printProvider.scales.getAt(this.printProvider.scales.getCount()-1),i=n.object.box.geometry.getBounds(),r=t.feature.geometry.getBounds(),e=t.scale===u&&i.containsBounds(r),o=t.scale===f&&r.containsBounds(i);(e===!0||o===!0)&&this.updateBox()}return delete this._updating,!1},transformcomplete:this.updateBox,scope:this}},this.transformFeatureOptions))},fitPage:function(){this.page&&this.page.fit(this.map,{mode:"screen"})},updateBox:function(){var n=this.page;this.control.active&&this.control.setFeature(n.feature,{rotation:-n.rotation})},onPageChange:function(n){this._updating||this.control.active&&this.control.setFeature(n.feature,{rotation:-n.rotation})}})