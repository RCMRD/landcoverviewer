Ext.define("GeoExt.form.field.GeocoderComboBox",{extend:"Ext.form.field.ComboBox",requires:["GeoExt.panel.Map","Ext.data.JsonStore","Ext.data.proxy.JsonP"],alias:"widget.gx_geocodercombo",alternateClassName:"GeoExt.form.GeocoderComboBox",emptyText:"Search",srs:"EPSG:4326",zoom:10,queryDelay:100,valueField:"bounds",displayField:"name",locationField:"lonlat",url:"http://nominatim.openstreetmap.org/search?format=json",queryParam:"q",minChars:3,store:null,center:null,locationFeature:null,initComponent:function(){this.map&&this.setMap(this.map);Ext.isString(this.srs)&&(this.srs=new OpenLayers.Projection(this.srs));this.store||(this.store=Ext.create("Ext.data.JsonStore",{root:null,fields:[{name:"name",mapping:"display_name"},{name:"bounds",convert:function(n,t){var i=t.raw.boundingbox;return[i[2],i[0],i[3],i[1]]}},{name:"lonlat",convert:function(n,t){return[t.raw.lon,t.raw.lat]}}],proxy:Ext.create("Ext.data.proxy.JsonP",{url:this.url,callbackKey:"json_callback"})}));this.on({added:this.findMapPanel,select:this.handleSelect,focus:function(){this.clearValue();this.removeLocationFeature()},scope:this});return this.callParent(arguments)},findMapPanel:function(){var n=this.up("gx_mappanel");n&&this.setMap(n)},handleSelect:function(n,t){var i,r,u,f;this.map||this.findMapPanel();i=this.getValue();Ext.isArray(i)&&(r=this.map.getProjectionObject(),delete this.center,delete this.locationFeature,i.length===4?this.map.zoomToExtent(OpenLayers.Bounds.fromArray(i).transform(this.srs,r)):this.map.setCenter(OpenLayers.LonLat.fromArray(i).transform(this.srs,r),Math.max(this.map.getZoom(),this.zoom)),t=t[0],this.center=this.map.getCenter(),u=t.get(this.locationField),this.layer&&u&&(f=new OpenLayers.Geometry.Point(u[0],u[1]).transform(this.srs,r),this.locationFeature=new OpenLayers.Feature.Vector(f,t.data),this.layer.addFeatures([this.locationFeature])))},removeLocationFeature:function(){this.locationFeature&&this.layer.destroyFeatures([this.locationFeature])},clearResult:function(){this.center&&!this.map.getCenter().equals(this.center)&&this.clearValue()},setMap:function(n){n instanceof GeoExt.panel.Map&&(n=n.map);this.map=n;n.events.on({moveend:this.clearResult,click:this.removeLocationFeature,scope:this})},addToMapPanel:Ext.emptyFn,beforeDestroy:function(){this.map&&this.map.events&&this.map.events.un({moveend:this.clearResult,click:this.removeLocationFeature,scope:this});this.removeLocationFeature();delete this.map;delete this.layer;delete this.center;this.callParent(arguments)}})