Ext.define("GeoExt.selection.FeatureModel",{extend:"Ext.selection.RowModel",alias:"selection.featuremodel",requires:["GeoExt.Version"],autoActivateControl:!0,layerFromStore:!0,selectControl:null,bound:!1,selectedFeatures:[],autoPanMapOnSelection:!1,constructor:function(n){if(n=n||{},n.selectControl instanceof OpenLayers.Control.SelectFeature){if(!n.singleSelect){var t=n.selectControl;n.singleSelect=!(t.multiple||!!t.multipleKey)}}else n.layer instanceof OpenLayers.Layer.Vector&&(this.selectControl=this.createSelectControl(n.layer,n.selectControl),delete n.layer,delete n.selectControl);n.autoPanMapOnSelection&&(this.autoPanMapOnSelection=!0,delete n.autoPanMapOnSelection);this.callParent(arguments)},bindComponent:function(){if(this.callParent(arguments),this.layerFromStore){var n=this.view.getStore()&&this.view.getStore().layer;!n||this.selectControl instanceof OpenLayers.Control.SelectFeature||(this.selectControl=this.createSelectControl(n,this.selectControl))}this.selectControl&&this.bind(this.selectControl)},createSelectControl:function(n,t){var r,i;return t=t||{},r=t.singleSelect!==undefined?t.singleSelect:this.singleSelect,t=OpenLayers.Util.extend({toggle:!0,multipleKey:r?null:Ext.isMac?"metaKey":"ctrlKey"},t),i=new OpenLayers.Control.SelectFeature(n,t),n.map.addControl(i),i},bind:function(n,t){var r,i,u;if(!this.bound){for(t=t||{},this.selectControl=n,n instanceof OpenLayers.Layer.Vector&&(this.selectControl=this.createSelectControl(n,t.controlConfig)),this.autoActivateControl&&this.selectControl.activate(),r=this.getLayers(),i=0,u=r.length;i<u;i++)r[i].events.on({featureselected:this.featureSelected,featureunselected:this.featureUnselected,scope:this});this.bound=!0}return this.selectControl},unbind:function(){var i=this.selectControl,t,n,r;if(this.bound){for(t=this.getLayers(),n=0,r=t.length;n<r;n++)t[n].events.un({featureselected:this.featureSelected,featureunselected:this.featureUnselected,scope:this});this.autoActivateControl&&i.deactivate();this.selectControl=null;this.bound=!1}return i},featureSelected:function(n){if(!this._selecting){var i=this.view.store,t=i.findBy(function(t){return t.raw==n.feature});t==-1||this.isSelected(t)||(this._selecting=!0,this.select(t,!this.singleSelect),this._selecting=!1,this.view.focusRow(t))}},featureUnselected:function(n){if(!this._selecting){var i=this.view.store,t=i.findBy(function(t){return t.raw==n.feature});t!=-1&&this.isSelected(t)&&(this._selecting=!0,this.deselect(t),this._selecting=!1,this.view.focusRow(t))}},onSelectChange:function(n,t){var i,u,r,f;if(this.callParent(arguments),i=n.raw,this.selectControl&&!this._selecting&&i)if(u=this.getLayers(),t){for(r=0,f=u.length;r<f;r++)if(Ext.Array.indexOf(u[r].selectedFeatures,i)==-1){this._selecting=!0;this.selectControl.select(i);this._selecting=!1;this.selectedFeatures.push(i);break}this.autoPanMapOnSelection&&this.recenterToSelectionExtent()}else{for(r=0,f=u.length;r<f;r++)if(Ext.Array.indexOf(u[r].selectedFeatures,i)!=-1){this._selecting=!0;this.selectControl.unselect(i);this._selecting=!1;OpenLayers.Util.removeItem(this.selectedFeatures,i);break}this.autoPanMapOnSelection&&this.selectedFeatures.length>0&&this.recenterToSelectionExtent()}},getLayers:function(){return this.selectControl.layers||[this.selectControl.layer]},recenterToSelectionExtent:function(){var n=this.selectControl.map,t=this.getSelectionExtent(),i=n.getZoomForExtent(t,!1);i>n.getZoom()?n.setCenter(t.getCenterLonLat()):n.zoomToExtent(t)},getSelectionExtent:function(){var n=null,t=this.selectedFeatures,i,r,u;if(t&&t.length>0)for(i=null,r=0,u=t.length;r<u;r++)i=t[r].geometry,i&&(n===null&&(n=new OpenLayers.Bounds),n.extend(i.getBounds()));return n}})