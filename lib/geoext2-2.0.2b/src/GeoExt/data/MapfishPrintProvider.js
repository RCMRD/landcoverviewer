Ext.define("GeoExt.data.MapfishPrintProvider",{extend:"Ext.util.Observable",requires:["Ext.data.JsonStore","GeoExt.Version"],url:null,capabilities:null,method:"POST",encoding:document.charset||document.characterSet||"UTF-8",timeout:3e4,customParams:null,scales:null,dpis:null,layouts:null,dpi:null,layout:null,constructor:function(n){this.initialConfig=n;Ext.apply(this,n);this.customParams||(this.customParams={});this.callParent(arguments);this.scales=Ext.create("Ext.data.JsonStore",{proxy:{type:"memory",reader:{type:"json",root:"scales"}},fields:["name",{name:"value",type:"float"}],sortOnLoad:!0,sorters:{property:"value",direction:"DESC"}});this.dpis=Ext.create("Ext.data.JsonStore",{proxy:{type:"memory",reader:{type:"json",root:"dpis"}},fields:["name",{name:"value",type:"float"}]});this.layouts=Ext.create("Ext.data.JsonStore",{proxy:{type:"memory",reader:{type:"json",root:"layouts"}},fields:["name",{name:"size",mapping:"map"},{name:"rotation",type:"boolean"}]});n.capabilities?this.loadStores():(this.url.split("/").pop()&&(this.url+="/"),this.initialConfig.autoLoad&&this.loadCapabilities())},setLayout:function(n){this.layout=n;this.fireEvent("layoutchange",this,n)},setDpi:function(n){this.dpi=n;this.fireEvent("dpichange",this,n)},print:function(n,t,i){var o,s,u,h,f,l;if(n instanceof GeoExt.MapPanel&&(n=n.map),t=t instanceof Array?t:[t],i=i||{},this.fireEvent("beforeprint",this,n,t,i)!==!1){var r=Ext.apply({units:n.getUnits(),srs:n.baseLayer.projection.getCode(),layout:this.layout.get("name"),dpi:this.dpi.get("value")},this.customParams),a=t[0].feature.layer,c=[],e=n.layers.concat();Ext.Array.remove(e,n.baseLayer);Ext.Array.insert(e,0,[n.baseLayer]);Ext.each(e,function(n){if(n!==a&&n.getVisibility()===!0){var t=this.encodeLayer(n);t&&c.push(t)}},this);r.layers=c;o=[];Ext.each(t,function(n){o.push(Ext.apply({center:[n.center.lon,n.center.lat],scale:n.scale.get("value"),rotation:n.rotation},n.customParams))},this);r.pages=o;i.overview&&(s=[],Ext.each(i.overview.layers,function(n){var t=this.encodeLayer(n);t&&s.push(t)},this),r.overviewLayers=s);!i.legend||this.fireEvent("beforeencodelegend",this,r,i.legend)===!1||(u=i.legend,h=u.rendered,h||(u=u.cloneConfig({renderTo:document.body,hidden:!0})),f=[],u.items&&u.items.each(function(n){if(!n.hidden){var t=this.encoders.legends[n.getXType()];f=f.concat(t.call(this,n,r.pages[0].scale))}},this),h||u.destroy(),r.legends=f);this.method==="GET"?(l=Ext.urlAppend(this.capabilities.printURL,"spec="+encodeURIComponent(Ext.encode(r))),this.download(l)):Ext.Ajax.request({url:this.capabilities.createURL,timeout:this.timeout,jsonData:r,headers:{"Content-Type":"application/json; charset="+this.encoding},success:function(n){var t=Ext.decode(n.responseText).getURL;this.download(t)},failure:function(n){this.fireEvent("printexception",this,n)},params:this.initialConfig.baseParams,scope:this})}},download:function(n){this.fireEvent("beforedownload",this,n)!==!1&&(Ext.isOpera?window.open(n):window.location.href=n);this.fireEvent("print",this,n)},loadCapabilities:function(){if(this.url){var n=this.url+"info.json";Ext.Ajax.request({url:n,method:"GET",disableCaching:!1,success:function(n){this.capabilities=Ext.decode(n.responseText);this.loadStores()},params:this.initialConfig.baseParams,scope:this})}},loadStores:function(){this.scales.loadRawData(this.capabilities);this.dpis.loadRawData(this.capabilities);this.layouts.loadRawData(this.capabilities);this.setLayout(this.layouts.getAt(0));this.setDpi(this.dpis.getAt(0));this.fireEvent("loadcapabilities",this,this.capabilities)},encodeLayer:function(n){var t;for(var i in this.encoders.layers)if(OpenLayers.Layer[i]&&n instanceof OpenLayers.Layer[i]){if(this.fireEvent("beforeencodelayer",this,n)===!1)return;t=this.encoders.layers[i].call(this,n);this.fireEvent("encodelayer",this,n,t);break}return t&&t.type?t:null},getAbsoluteUrl:function(n){var t;return Ext.isIE6||Ext.isIE7||Ext.isIE8?(t=document.createElement("<a href='"+n+"'/>"),t.style.display="none",document.body.appendChild(t),t.href=t.href,document.body.removeChild(t)):(t=document.createElement("a"),t.href=n),t.href},encoders:{layers:{Layer:function(n){var t={};return n.options&&n.options.maxScale&&(t.minScaleDenominator=n.options.maxScale),n.options&&n.options.minScale&&(t.maxScaleDenominator=n.options.minScale),t},WMS:function(n){var t=this.encoders.layers.HTTPRequest.call(this,n),r,i;Ext.apply(t,{type:"WMS",layers:[n.params.LAYERS].join(",").split(","),format:n.params.FORMAT,styles:[n.params.STYLES].join(",").split(",")});for(i in n.params)r=i.toLowerCase(),n.DEFAULT_PARAMS[r]||"layers,styles,width,height,srs".indexOf(r)!=-1||(t.customParams||(t.customParams={}),t.customParams[i]=n.params[i]);return t},OSM:function(n){var t=this.encoders.layers.TileCache.call(this,n);return Ext.apply(t,{type:"OSM",baseURL:t.baseURL.substr(0,t.baseURL.indexOf("$")),extension:"png"})},TMS:function(n){var t=this.encoders.layers.TileCache.call(this,n);return Ext.apply(t,{type:"TMS",format:n.type})},TileCache:function(n){var t=this.encoders.layers.HTTPRequest.call(this,n);return Ext.apply(t,{type:"TileCache",layer:n.layername,maxExtent:n.maxExtent.toArray(),tileSize:[n.tileSize.w,n.tileSize.h],extension:n.extension,resolutions:n.serverResolutions||n.resolutions})},WMTS:function(n){var t=this.encoders.layers.HTTPRequest.call(this,n);return Ext.apply(t,{type:"WMTS",layer:n.layer,version:n.version,requestEncoding:n.requestEncoding,tileOrigin:[n.tileOrigin.lon,n.tileOrigin.lat],tileSize:[n.tileSize.w,n.tileSize.h],style:n.style,formatSuffix:n.formatSuffix,dimensions:n.dimensions,params:n.params,maxExtent:n.tileFullExtent!=null?n.tileFullExtent.toArray():n.maxExtent.toArray(),matrixSet:n.matrixSet,zoomOffset:n.zoomOffset,resolutions:n.serverResolutions||n.resolutions})},KaMapCache:function(n){var t=this.encoders.layers.KaMap.call(this,n);return Ext.apply(t,{type:"KaMapCache",group:n.params.g,metaTileWidth:n.params.metaTileSize.w,metaTileHeight:n.params.metaTileSize.h})},KaMap:function(n){var t=this.encoders.layers.HTTPRequest.call(this,n);return Ext.apply(t,{type:"KaMap",map:n.params.map,extension:n.params.i,group:n.params.g||"",maxExtent:n.maxExtent.toArray(),tileSize:[n.tileSize.w,n.tileSize.h],resolutions:n.serverResolutions||n.resolutions})},HTTPRequest:function(n){var t=this.encoders.layers.Layer.call(this,n);return Ext.apply(t,{baseURL:this.getAbsoluteUrl(n.url instanceof Array?n.url[0]:n.url),opacity:n.opacity!=null?n.opacity:1,singleTile:n.singleTile})},Image:function(n){var t=this.encoders.layers.Layer.call(this,n);return Ext.apply(t,{type:"Image",baseURL:this.getAbsoluteUrl(n.getURL(n.extent)),opacity:n.opacity!=null?n.opacity:1,extent:n.extent.toArray(),pixelSize:[n.size.w,n.size.h],name:n.name})},Vector:function(n){var u,v,f,y;if(n.features.length){var s=[],h={},c=n.features,l=new OpenLayers.Format.GeoJSON,p=new OpenLayers.Format.JSON,w=1,a={},i,t,e,o,r;for(u=0,v=c.length;u<v;++u)i=c[u],t=i.style||n.style||n.styleMap.createSymbolizer(i,i.renderIntent),e=p.write(t),o=a[e],o?r=o:(a[e]=r=w++,h[r]=t.externalGraphic?Ext.applyIf({externalGraphic:this.getAbsoluteUrl(t.externalGraphic)},t):t),f=l.extract.feature.call(l,i),f.properties=OpenLayers.Util.extend({_gx_style:r},f.properties),s.push(f);return y=this.encoders.layers.Layer.call(this,n),Ext.apply(y,{type:"Vector",styles:h,styleProperty:"_gx_style",geoJson:{type:"FeatureCollection",features:s},name:n.name,opacity:n.opacity!=null?n.opacity:1})}},Markers:function(n){for(var i,f,u=[],r=0,e=n.markers.length;r<e;r++){var t=n.markers[r],o=new OpenLayers.Geometry.Point(t.lonlat.lon,t.lonlat.lat),s={externalGraphic:t.icon.url,graphicWidth:t.icon.size.w,graphicHeight:t.icon.size.h,graphicXOffset:t.icon.offset.x,graphicYOffset:t.icon.offset.y},h=new OpenLayers.Feature.Vector(o,{},s);u.push(h)}return i=new OpenLayers.Layer.Vector(n.name),i.addFeatures(u),f=this.encoders.layers.Vector.call(this,i),i.destroy(),f}},legends:{gx_wmslegend:function(n,t){for(var i,u,f,e=this.encoders.legends.base.call(this,n),o=[],r=1,s=n.items.getCount();r<s;++r)i=n.items.get(r).url,n.useScaleParameter===!0&&i.toLowerCase().indexOf("request=getlegendgraphic")!=-1&&(u=i.split("?"),f=Ext.urlDecode(u[1]),f.SCALE=t,i=u[0]+"?"+Ext.urlEncode(f)),o.push(this.getAbsoluteUrl(i));return e[0].classes[0]={name:"",icons:o},e},gx_urllegend:function(n){var t=this.encoders.legends.base.call(this,n);return t[0].classes.push({name:"",icon:this.getAbsoluteUrl(n.items.get(1).url)}),t},base:function(n){return[{name:n.getLabel(),classes:[]}]}}}})