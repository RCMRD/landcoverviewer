Ext.define("GeoExt.data.reader.WmsCapabilities",{alternateClassName:["GeoExt.data.reader.WMSCapabilities","GeoExt.data.WMSCapabilitiesReader"],extend:"Ext.data.reader.Json",alias:"reader.gx_wmscapabilities",requires:["GeoExt.Version"],constructor:function(n){this.model||(this.model="GeoExt.data.WmsCapabilitiesLayerModel");this.callParent([n]);this.format||(this.format=new OpenLayers.Format.WMSCapabilities)},keepRaw:!1,raw:null,attributionCls:"gx-attribution",getResponseData:function(n){var t=n.responseXML;return t&&t.documentElement||(t=n.responseText),this.readRecords(t)},serviceExceptionFormat:function(n){return OpenLayers.Util.indexOf(n,"application/vnd.ogc.se_inimage")>-1?"application/vnd.ogc.se_inimage":OpenLayers.Util.indexOf(n,"application/vnd.ogc.se_xml")>-1?"application/vnd.ogc.se_xml":n[0]},imageFormat:function(n){var t=n.formats;return n.opaque&&OpenLayers.Util.indexOf(t,"image/jpeg")>-1?"image/jpeg":OpenLayers.Util.indexOf(t,"image/png")>-1?"image/png":OpenLayers.Util.indexOf(t,"image/png; mode=24bit")>-1?"image/png; mode=24bit":OpenLayers.Util.indexOf(t,"image/gif")>-1?"image/gif":t[0]},imageTransparent:function(n){return n.opaque==undefined||!n.opaque},destroyReader:function(){var n=this;delete n.raw;this.callParent()},readRecords:function(n){var o,t,r,s,h,c,u,v,f,y;if(Ext.isArray(n))return this.callParent(n);(typeof n=="string"||n.nodeType)&&(n=this.format.read(n));!n.error||Ext.Error.raise({msg:"Error parsing WMS GetCapabilities",arg:n.error});this.keepRaw&&(this.raw=n);var p=n.version,i=n.capability||{},l=i.request&&i.request.getmap&&i.request.getmap.href,e=i.layers,w=i.exception?i.exception.formats:[],b=this.serviceExceptionFormat(w),a=[];if(l&&e)for(o=this.getFields(),u=0,v=e.length;u<v;u++)if(t=e[u],t.name){for(r={},f=0,y=o.length;f<y;f++)c=o[f],r[c.name]=t[c.name];r.name=t.name;s={attribution:t.attribution?this.attributionMarkup(t.attribution):undefined,minScale:t.minScale,maxScale:t.maxScale,metadata:r};this.layerOptions&&Ext.apply(s,this.layerOptions);h={layers:t.name,exceptions:b,format:this.imageFormat(t),transparent:this.imageTransparent(t),version:p};this.layerParams&&Ext.apply(h,this.layerParams);t=new OpenLayers.Layer.WMS(t.title||t.name,l,h,s);a.push(t)}return this.callParent([a])},attributionMarkup:function(n){var t=[],i;if(n.logo&&t.push("<img class='"+this.attributionCls+"-image' src='"+n.logo.href+"' />"),n.title&&t.push("<span class='"+this.attributionCls+"-title'>"+n.title+"<\/span>"),n.href)for(i=0;i<t.length;i++)t[i]="<a class='"+this.attributionCls+"-link' href="+n.href+">"+t[i]+"<\/a>";return t.join(" ")}})