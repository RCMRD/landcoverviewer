Ext.define("GeoExt.data.PrintPage",{extend:"Ext.util.Observable",requires:["GeoExt.panel.Map"],printProvider:null,feature:null,center:null,scale:null,rotation:0,customParams:null,constructor:function(n){if(this.initialConfig=n,Ext.apply(this,n),this.customParams||(this.customParams={}),this.callParent(arguments),this.feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([new OpenLayers.Geometry.Point(-1,-1),new OpenLayers.Geometry.Point(1,-1),new OpenLayers.Geometry.Point(1,1),new OpenLayers.Geometry.Point(-1,1)])])),this.printProvider.capabilities)this.setScale(this.printProvider.scales.getAt(0));else this.printProvider.on({loadcapabilities:function(){this.setScale(this.printProvider.scales.getAt(0))},scope:this,single:!0});this.printProvider.on({layoutchange:this.onLayoutChange,scope:this})},getPrintExtent:function(n){return n=n instanceof GeoExt.MapPanel?n.map:n,this.calculatePageBounds(this.scale,n.getUnits())},setScale:function(n,t){var u=this.calculatePageBounds(n,t),i=u.toGeometry(),r=this.rotation;Ext.isDefined(r)&&r!=0&&i.rotate(-r,i.getCentroid());this.updateFeature(i,{scale:n})},setCenter:function(n){var t=this.feature.geometry,i=t.getBounds().getCenterLonLat(),r=n.lon-i.lon,u=n.lat-i.lat;t.move(r,u);this.updateFeature(t,{center:n})},setRotation:function(n,t){if(t||this.printProvider.layout.get("rotation")===!0){var i=this.feature.geometry;i.rotate(this.rotation-n,i.getCentroid());this.updateFeature(i,{rotation:n})}},fit:function(n,t){var r,i,f;if(t=t||{},r=n,n instanceof GeoExt.panel.Map?r=n.map:n instanceof OpenLayers.Feature.Vector&&(r=n.layer.map,i=n.geometry.getBounds()),i||(i=r.getExtent(),i)){this._updating=!0;f=i.getCenterLonLat();this.setCenter(f);var e=r.getUnits(),u=this.printProvider.scales.getAt(0),o=Number.POSITIVE_INFINITY,s=i.getWidth(),h=i.getHeight();this.printProvider.scales.each(function(n){var r=this.calculatePageBounds(n,e),c,f;if(t.mode=="closest")c=Math.abs(r.getWidth()-s)+Math.abs(r.getHeight()-h),c<o&&(o=c,u=n);else return f=t.mode=="screen"?!i.containsBounds(r):r.containsBounds(i),(f||t.mode=="screen"&&!f)&&(u=n),f},this);this.setScale(u,e);delete this._updating;this.updateFeature(this.feature.geometry,{center:f,scale:u})}},updateFeature:function(n,t){var i=this.feature,u=i.geometry!==n,r;if(n.id=i.geometry.id,i.geometry=n,!this._updating){for(r in t)t[r]===this[r]?delete t[r]:(this[r]=t[r],u=!0);Ext.apply(this,t);i.layer&&i.layer.drawFeature(i);u&&this.fireEvent("change",this,t)}},calculatePageBounds:function(n,t){var u=n.get("value"),r=this.feature,h=this.feature.geometry,i=h.getBounds().getCenterLonLat(),f=this.printProvider.layout.get("size"),t=t||r.layer&&r.layer.map&&r.layer.map.getUnits()||"dd",e=OpenLayers.INCHES_PER_UNIT[t],o=f.width/72/e*u/2,s=f.height/72/e*u/2;return new OpenLayers.Bounds(i.lon-o,i.lat-s,i.lon+o,i.lat+s)},onLayoutChange:function(){this.printProvider.layout.get("rotation")===!1&&this.setRotation(0,!0);this.scale&&this.setScale(this.scale)},destroy:function(){this.printProvider.un("layoutchange",this.onLayoutChange,this)}})