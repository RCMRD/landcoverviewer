Ext.define("GeoExt.window.Popup",{extend:"Ext.window.Window",alias:"widget.gx_popup",alternateClassName:"GeoExt.Popup",requires:["GeoExt.Version"],insideViewport:null,animCollapse:!1,draggable:!1,shadow:!1,unpinnable:!0,map:null,anchored:!0,panIn:!0,location:null,popupCls:"gx-popup",ancCls:null,anchorPosition:"auto",alwaysOnTop:!1,initComponent:function(){this.map instanceof GeoExt.panel.Map&&(this.map=this.map.map);!this.map&&this.location instanceof OpenLayers.Feature.Vector&&this.location.layer&&(this.map=this.location.layer.map);this.location instanceof OpenLayers.Feature.Vector&&(this.location=this.location.geometry);this.location instanceof OpenLayers.Geometry?(typeof this.location.getCentroid=="function"&&(this.location=this.location.getCentroid()),this.location=this.location.getBounds().getCenterLonLat()):this.location instanceof OpenLayers.Pixel?this.location=this.map.getLonLatFromViewPortPx(this.location):this.anchored=!1;var n=this.map.getExtent();n&&this.location&&(this.insideViewport=n.containsLonLat(this.location));this.anchored&&this.addAnchorEvents();this.elements+=",anc";this.callParent(arguments)},onRender:function(){this.callParent(arguments);this.addCls(this.popupCls);this.ancCls=this.popupCls+"-anc";var n=Ext.core.DomHelper,t={tag:"div",cls:this.ancCls},i=n.append(this.el.dom,t);this.anc=Ext.get(i)},initTools:function(){this.unpinnable&&(this.tools||(this.tools=[]),this.tools.push({type:"unpin",handler:Ext.bind(this.unanchorPopup,this,[])}));this.callParent(arguments)},show:function(){this.callParent(arguments);this.anchored&&(this.position(),this.panIn&&!this._mapMove&&this.panIntoView())},maximize:function(){!this.maximized&&this.anc&&this.unanchorPopup();this.callParent(arguments)},setSize:function(n,t){if(this.anc){var i=this.anc.getSize();typeof n=="object"?(t=n.height-i.height,n=n.width):isNaN(t)||(t=t-i.height)}this.callParent([n,t])},position:function(){var s,h,e;if(this._mapMove===!0&&(this.insideViewport=this.map.getExtent().containsLonLat(this.location),this.insideViewport!==this.isVisible()&&this.setVisible(this.insideViewport)),this.isVisible()){var t=this.map.getPixelFromLonLat(this.location),i=Ext.fly(this.map.div).getBox(!0),r=t.y+i.y,u=t.x+i.x,f=this.el.getSize(),n=this.anc.getSize(),o=this.anchorPosition;o.indexOf("right")>-1||t.x>i.width/2?(this.anc.addCls("right"),s=this.el.getX(!0)+f.width-this.anc.getX(!0)-n.width,u-=f.width-s-n.width/2):(this.anc.removeCls("right"),h=this.anc.getLeft(!0),u-=h+n.width/2);o.indexOf("bottom")>-1||t.y>i.height/2?(this.anc.removeCls("top"),e=this.getHeight(),isNaN(e)===!1&&this.anc.setTop(e-1+"px"),r-=f.height+n.height):(this.anc.addCls("top"),this.anc.setTop(""),r+=n.height);this.setPosition(u,r);this.handleAlwaysOnTop()}},handleAlwaysOnTop:function(){this.alwaysOnTop&&Ext.versions.core.major===4&&Ext.WindowManager.bringToFront(this.id)},unanchorPopup:function(){this.removeAnchorEvents();this.draggable=!0;this.header.addCls("x-window-header-draggable");var n="#"+Ext.escapeId(this.header.id),t=Ext.applyIf({el:this.el,delegate:n,constrain:this.constrain,constrainDelegate:this.constrainHeader?n:!1,constrainTo:this.constrainTo},this.draggable);this.dd=new Ext.util.ComponentDragger(this,t);this.anc.remove();this.anc=null;this.tools.unpin.hide()},panIntoView:function(){var r=Ext.fly(this.map.div).getBox(!0),n=this.getPosition(!0),e,o;n[0]-=r.x;n[1]-=r.y;var u=[r.width,r.height],f=this.getSize(),i=[n[0],n[1]],t=this.map.paddingForPopups;n[0]<t.left?i[0]=t.left:n[0]+f.width>u[0]-t.right&&(i[0]=u[0]-t.right-f.width);n[1]<t.top?i[1]=t.top:n[1]+f.height>u[1]-t.bottom&&(i[1]=u[1]-t.bottom-f.height);e=n[0]-i[0];o=n[1]-i[1];this.map.pan(e,o)},onMapMove:function(){this.hidden&&this.insideViewport||(this._mapMove=!0,this.position(),delete this._mapMove)},addAnchorEvents:function(){this.map.events.on({move:this.onMapMove,scope:this});this.on({resize:this.position,scope:this})},removeAnchorEvents:function(){this.map.events.un({move:this.onMapMove,scope:this});this.un("resize",this.position,this)},beforeDestroy:function(){this.anchored&&this.removeAnchorEvents();this.callParent(arguments)}})