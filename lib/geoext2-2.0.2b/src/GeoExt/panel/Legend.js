Ext.define("GeoExt.panel.Legend",{extend:"Ext.panel.Panel",requires:["GeoExt.container.LayerLegend"],alias:"widget.gx_legendpanel",alternateClassName:"GeoExt.LegendPanel",dynamic:!0,layerStore:null,preferredTypes:null,filter:function(){return!0},onRender:function(){if(this.callParent(arguments),this.layerStore||(this.layerStore=GeoExt.panel.Map.guess().layers),this.layerStore.each(function(n){this.addLegend(n)},this),this.dynamic)this.layerStore.on({add:this.onStoreAdd,remove:this.onStoreRemove,clear:this.onStoreClear,scope:this})},recordIndexToPanelIndex:function(n){for(var e,i=this.layerStore,o=i.getCount(),r=-1,s=this.items?this.items.length:0,u,f,t=o-1;t>=0;--t)if(u=i.getAt(t),f=u.getLayer(),e=GeoExt.container.LayerLegend.getTypes(u),f.displayInLayerSwitcher&&e.length>0&&i.getAt(t).get("hideInLegend")!==!0&&(++r,n===t||r>s-1))break;return r},getIdForLayer:function(n){return this.id+"-"+n.id},onStoreAdd:function(n,t,i){for(var u=this.recordIndexToPanelIndex(i+t.length-1),r=0,f=t.length;r<f;r++)this.addLegend(t[r],u);this.doLayout()},onStoreRemove:function(n,t){this.removeLegend(t)},removeLegend:function(n){if(this.items){var t=this.getComponent(this.getIdForLayer(n.getLayer()));t&&(this.remove(t,!0),this.doLayout())}},onStoreClear:function(){this.removeAllLegends()},removeAllLegends:function(){this.removeAll(!0);this.doLayout()},addLegend:function(n,t){var i,r;this.filter(n)===!0&&(i=n.getLayer(),t=t||0,r=GeoExt.container.LayerLegend.getTypes(n,this.preferredTypes),i.displayInLayerSwitcher&&!n.get("hideInLegend")&&r.length>0&&this.insert(t,{xtype:r[0],id:this.getIdForLayer(i),layerRecord:n,hidden:!(!i.map&&i.visibility||i.getVisibility()&&i.calculateInRange())}))},onDestroy:function(){this.layerStore&&(this.layerStore.un("add",this.onStoreAdd,this),this.layerStore.un("remove",this.onStoreRemove,this),this.layerStore.un("clear",this.onStoreClear,this));this.callParent(arguments)}})