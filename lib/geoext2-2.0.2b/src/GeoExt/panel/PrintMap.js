Ext.define("GeoExt.panel.PrintMap",{extend:"GeoExt.panel.Map",requires:["Ext.data.Store","GeoExt.data.MapfishPrintProvider","GeoExt.data.PrintPage"],alias:"widget.gx_printmappanel",alternateClassName:"GeoExt.PrintMapPanel",sourceMap:null,printProvider:null,printPage:null,previewScales:null,center:null,zoom:null,extent:null,currentZoom:null,initComponent:function(){this.sourceMap instanceof GeoExt.MapPanel&&(this.sourceMap=this.sourceMap.map);this.map||(this.map={});Ext.applyIf(this.map,{projection:this.sourceMap.getProjection(),maxExtent:this.sourceMap.getMaxExtent(),maxResolution:this.sourceMap.getMaxResolution(),units:this.sourceMap.getUnits(),tileManager:null,allOverlays:!0,fallThrough:!0});this.printProvider instanceof GeoExt.data.MapfishPrintProvider||(this.printProvider=Ext.create("GeoExt.data.MapfishPrintProvider",this.printProvider));this.printPage=Ext.create("GeoExt.data.PrintPage",{printProvider:this.printProvider});this.previewScales=Ext.create("Ext.data.Store",{fields:[{name:"name",type:"string"},{name:"value",type:"int"}],data:this.printProvider.scales.getRange()});this.layers=[];Ext.each(this.sourceMap.layers,function(n){n.getVisibility()===!0&&this.layers.push(n.clone())},this);this.extent=this.sourceMap.getExtent();this.callParent(arguments)},syncSize:function(){var n=this.adjustSize(this.map.size.w,this.map.size.h);this.setSize(n.width,n.height)},bind:function(){this.syncSize();this.printPage.on("change",this.fitZoom,this);this.printProvider.on("layoutchange",this.syncSize,this);this.map.events.register("moveend",this,this.updatePage);this.on("resize",function(){this.doComponentLayout();this.map.updateSize()},this);if(this.printPage.fit(this.sourceMap),this.initialConfig.limitScales===!0){this.on("resize",this.calculatePreviewScales,this);this.calculatePreviewScales()}},afterRender:function(){var n=this,t={afterlayout:{fn:n.bind,scope:n,single:!0}};if(n.callParent(arguments),n.doComponentLayout(),n.ownerCt)n.ownerCt.on(t);else n.on(t)},adjustSize:function(n,t){var e=this.printProvider.layout.get("size"),u=e.width/e.height,r=this.ownerCt,f=r&&r.autoWidth?0:n||this.initialConfig.width,i=r&&r.autoHeight?0:t||this.initialConfig.height;return f?(t=f/u,i&&t>i?(t=i,n=t*u):n=f):i&&(n=i*u,t=i),{width:n,height:t}},fitZoom:function(){if(!this._updating&&this.printPage.scale){this._updating=!0;var n=this.printPage.getPrintExtent(this.map);this.currentZoom=this.map.getZoomForExtent(n);this.map.zoomToExtent(n,!1);delete this._updating}},updatePage:function(){if(!this._updating){var n=this.map.getZoom();this._updating=!0;n===this.currentZoom?this.printPage.setCenter(this.map.getCenter()):this.printPage.fit(this.map);delete this._updating;this.currentZoom=n}},calculatePreviewScales:function(){var r,o,u,f;this.previewScales.removeAll();this.printPage.suspendEvents();var n=this.printPage.scale,e=this.map.getSize(),t={},i=[];for(this.printProvider.scales.each(function(n){this.printPage.setScale(n);var u=this.printPage.getPrintExtent(this.map),r=this.map.getZoomForExtent(u),o=Math.max(u.getWidth()/e.w,u.getHeight()/e.h),s=this.map.getResolutionForZoom(r),f=Math.abs(o-s);(!(r in t)||t[r].diff>f)&&(t[r]={rec:n,diff:f},Ext.Array.indexOf(i,r)===-1&&i.push(r))},this),r=0,o=i.length;r<o;++r)this.previewScales.add(t[i[r]].rec);n&&this.printPage.setScale(n);this.printPage.resumeEvents();n&&this.previewScales.getCount()>0&&(u=this.previewScales.getAt(0),f=this.previewScales.getAt(this.previewScales.getCount()-1),n.get("value")<f.get("value")?this.printPage.setScale(f):n.get("value")>u.get("value")&&this.printPage.setScale(u));this.fitZoom()},print:function(n){this.printProvider.print(this.map,[this.printPage],n)},beforeDestroy:function(){this.map.events.unregister("moveend",this,this.updatePage);this.printPage.un("change",this.fitZoom,this);this.printProvider.un("layoutchange",this.syncSize,this);this.callParent(arguments)}})