Ext.define("GeoExt.tree.LayerNode",{extend:"Ext.AbstractPlugin",alias:"plugin.gx_layer",requires:["GeoExt.Version"],init:function(n){this.target=n;var t=n.get("layer");n.set("checked",t.getVisibility());!n.get("checkedGroup")&&t.isBaseLayer&&n.set("checkedGroup","gx_baselayer");n.set("fixedText",!!n.text);n.set("leaf",!0);n.get("iconCls")||n.set("iconCls","gx-tree-layer-icon");n.on("afteredit",this.onAfterEdit,this);t.events.on({visibilitychanged:this.onLayerVisibilityChanged,scope:this});this.enforceOneVisible()},onAfterEdit:function(n,t){var i=this;~Ext.Array.indexOf(t,"checked")&&i.onCheckChange()},onLayerVisibilityChanged:function(){this._visibilityChanging||this.target.set("checked",this.target.get("layer").getVisibility())},onCheckChange:function(){var t=this.target,i=this.target.get("checked"),n;i!=t.get("layer").getVisibility()&&(t._visibilityChanging=!0,n=t.get("layer"),i&&n.isBaseLayer&&n.map?n.map.setBaseLayer(n):!i&&n.isBaseLayer&&n.map&&n.map.baseLayer&&n.id==n.map.baseLayer.id?t.set("checked",n.getVisibility()):n.setVisibility(i),delete t._visibilityChanging);this.enforceOneVisible()},enforceOneVisible:function(){var n=this.target.data,t=n.checkedGroup;if(t&&t!=="gx_baselayer"){var i=this.target.get("layer"),u=this.target.getOwnerTree().getChecked(),r=0;Ext.each(u,function(u){var f=u.data.layer;u.data.hidden||u.data.checkedGroup!==t||(r++,f!=i&&n.checked&&f.setVisibility(!1))});r===0&&n.checked==!1&&i.setVisibility(!0)}}})