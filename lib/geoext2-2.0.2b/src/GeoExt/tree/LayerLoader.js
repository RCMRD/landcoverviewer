Ext.define("GeoExt.tree.LayerLoader",{extend:"Ext.util.Observable",requires:["GeoExt.tree.LayerNode"],store:null,filter:function(n){return n.getLayer().displayInLayerSwitcher===!0},baseAttrs:null,load:function(n){if(this.fireEvent("beforeload",this,n)){for(this.removeStoreHandlers();n.firstChild;)n.removeChild(n.firstChild);this.store||(this.store=GeoExt.MapPanel.guess().layers);this.store.each(function(t){this.addLayerNode(n,t)},this);this.addStoreHandlers(n);this.fireEvent("load",this,n)}},onStoreAdd:function(n,t,i,r){var f,u,e;if(!this._reordering)for(f=r.get("container").recordIndexToNodeIndex(i+t.length-1,r),u=0,e=t.length;u<e;++u)this.addLayerNode(r,t[u],f)},onStoreRemove:function(n,t){this._reordering||this.removeLayerNode(t,n)},addLayerNode:function(n,t,i){if(i=i||0,this.filter(t)===!0){var r=t.getLayer(),u=this.createNode({plugins:[{ptype:"gx_layer"}],layer:r,text:r.name,listeners:{move:this.onChildMove,scope:this}});i!==undefined?n.insertChild(i,u):n.appendChild(u);n.getChildAt(i).on("move",this.onChildMove,this)}},removeLayerNode:function(n,t){if(this.filter(t)===!0){var i=n.findChildBy(function(n){return n.get("layer")==t.getLayer()});i&&(i.un("move",this.onChildMove,this),i.remove())}},onChildMove:function(n,t,i,r){var u=this,h=u.store.getByLayer(n.get("layer")),c=i.get("container"),s=c.loader,o,l,f,e;if(u._reordering=!0,s instanceof u.self&&u.store===s.store){if(s._reordering=!0,u.store.remove(h),i.childNodes.length>1)l=r===0?r+1:r-1,o=u.store.findBy(function(n){return i.childNodes[l].get("layer")===n.getLayer()}),r===0&&o++;else if(t.parentNode===i.parentNode){f=i;do f=f.previousSibling;while(f&&!(f.get("container")instanceof c.self&&f.lastChild));if(f)o=u.store.findBy(function(n){return f.lastChild.get("layer")===n.getLayer()});else{e=i;do e=e.nextSibling;while(e&&!(e.get("container")instanceof c.self&&e.firstChild));e&&(o=u.store.findBy(function(n){return e.firstChild.get("layer")===n.getLayer()}));o++}}o!==undefined?u.store.insert(o,[h]):u.store.insert(oldRecordIndex,[h]);delete s._reordering}delete u._reordering},addStoreHandlers:function(n){if(!this._storeHandlers){this._storeHandlers={add:function(t,i,r){this.onStoreAdd(t,i,r,n)},remove:function(t,i){this.onStoreRemove(i,n)}};for(var t in this._storeHandlers)this.store.on(t,this._storeHandlers[t],this)}},removeStoreHandlers:function(){if(this._storeHandlers){for(var n in this._storeHandlers)this.store.un(n,this._storeHandlers[n],this);delete this._storeHandlers}},createNode:function(n){return this.baseAttrs&&Ext.apply(n,this.baseAttrs),n},destroy:function(){this.removeStoreHandlers()}})